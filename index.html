<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NutriChakra 3x1 Pro + Editor</title>
    
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0f172a">

    <style>
        :root {
            --tipo-a: #10b981; --tipo-e: #ef4444; --bg: #0f172a; --card: #1e293b;
            --text: #f8fafc; --primary: #6366f1;
            --rojo: #ef4444; --naranja: #f97316; --amarillo: #facc15;
            --verde: #22c55e; --azul: #3b82f6; --indigo: #6366f1; --violeta: #a855f7;
        }

        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; height: 100vh; overflow: hidden; }
        
        .container { display: grid; grid-template-columns: 400px 1fr; gap: 20px; padding: 20px; height: 100vh; box-sizing: border-box; }
        .sidebar { background: var(--card); border-radius: 15px; display: flex; flex-direction: column; border: 1px solid #334155; overflow: hidden; }
        .sidebar-header { padding: 15px; background: rgba(0,0,0,0.2); }
        .food-container { overflow-y: auto; flex-grow: 1; padding: 10px; }

        .accordion-header { 
            width: 100%; padding: 12px; background: none; border: none; color: var(--primary); 
            font-weight: bold; text-align: left; cursor: pointer; border-bottom: 1px solid #334155;
            font-size: 0.8rem; text-transform: uppercase;
        }
        .accordion-content { display: none; padding: 5px; }
        .accordion-content.active { display: block; }

        .food-item { 
            display: flex; align-items: center; padding: 8px; margin-bottom: 5px;
            background: #2d3a4f; border-radius: 6px; font-size: 0.75rem; border-right: 5px solid var(--f-color);
        }
        .food-name { cursor: pointer; flex-grow: 1; display: flex; align-items: center; }
        .dot { width: 8px; height: 8px; border-radius: 50%; margin-right: 10px; }
        .dot-a { background: var(--tipo-a); } .dot-e { background: var(--tipo-e); }

        /* Edici√≥n de precio */
        .price-box { display: flex; align-items: center; gap: 4px; background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 4px; }
        .price-val { color: var(--amarillo); font-weight: bold; font-size: 0.7rem; }
        .btn-edit { cursor: pointer; font-size: 0.65rem; opacity: 0.6; transition: 0.2s; }
        .btn-edit:hover { opacity: 1; }

        .planner-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; height: 72vh; }
        .day-col { background: var(--card); border-radius: 12px; border-top: 6px solid var(--d-color); display: flex; flex-direction: column; }
        .day-head { padding: 8px; text-align: center; background: rgba(0,0,0,0.2); }
        .day-head b { color: var(--d-color); font-size: 0.8rem; display: block; }
        .day-head span { font-size: 0.55rem; opacity: 0.7; color: white; text-transform: uppercase; }

        .meal-box { flex: 1; padding: 5px; border-bottom: 1px solid #334155; overflow-y: auto; cursor: cell; }
        .meal-box.selected { background: rgba(99, 102, 241, 0.1); border: 2px solid var(--primary); }
        
        .plate-item { font-size: 0.65rem; padding: 4px; border-radius: 4px; margin-bottom: 3px; background: #0f172a; border-left: 3px solid var(--f-color); display: flex; justify-content: space-between; }
        .btn-remove { color: var(--tipo-e); cursor: pointer; font-weight: bold; }

        .analyzer { background: var(--card); padding: 15px; border-radius: 15px; margin-top: 15px; display: flex; align-items: center; gap: 20px; border: 1px solid #334155; }
        .plate-viz { width: 55px; height: 55px; border-radius: 50%; border: 3px solid #0f172a; }
        .chakra-badge { padding: 4px 12px; border-radius: 20px; font-size: 0.65rem; font-weight: bold; text-transform: uppercase; color: #fff; display: inline-block; margin-top: 5px; }
        .budget-val { font-size: 1.1rem; font-weight: bold; color: var(--amarillo); }
        .btn-print { background: var(--primary); color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; margin-left: auto; }

        input#search { width: 100%; padding: 10px; border-radius: 8px; border: none; background: #0f172a; color: white; outline: none; }

        #printArea { display: none; }
        @media print { .container { display: none !important; } #printArea { display: block !important; color: black; } table { width: 100%; border-collapse: collapse; } th, td { border: 1px solid #000; padding: 8px; } }
    </style>
</head>
<body>

<div class="container">
    <div class="sidebar">
        <div class="sidebar-header"><input type="text" id="search" placeholder="üîç Buscar alimento..." onkeyup="renderLibrary()"></div>
        <div class="food-container" id="accordionLibrary"></div>
    </div>

    <div class="main-content">
        <div class="planner-grid" id="grid"></div>
        <div class="analyzer">
            <div class="plate-viz" id="plateChart"></div>
            <div>
                <h4 id="analysisTitle" style="margin:0; font-size:0.9rem;">Analizador Energ√©tico</h4>
                <div id="chakraBadge" class="chakra-badge" style="background: #334155;">Chakra -</div>
                <p id="analysisDesc" style="font-size:0.7rem; color:#94a3b8; margin:5px 0 0">Click en un bloque</p>
            </div>
            <div style="text-align: right; border-left: 1px solid #334155; padding-left: 20px;">
                <span style="font-size: 0.55rem; opacity: 0.8; display: block;">PRESUPUESTO TOTAL</span>
                <div class="budget-val" id="totalBudget">COP 0</div>
            </div>
            <button class="btn-print" onclick="printList()">üõí Compras</button>
        </div>
    </div>
</div>

<div id="printArea"></div>

<script>
    const CHAKRAS = {
        'Dom': { c: 'var(--rojo)', n: 'Ra√≠z', i: 'Vitalidad' },
        'Lun': { c: 'var(--naranja)', n: 'Sacro', i: 'Creatividad' },
        'Mar': { c: 'var(--amarillo)', n: 'Plexo', i: 'Poder' },
        'Mie': { c: 'var(--verde)', n: 'Coraz√≥n', i: 'Amor' },
        'Jue': { c: 'var(--azul)', n: 'Garganta', i: 'Verdad' },
        'Vie': { c: 'var(--indigo)', n: '3er Ojo', i: 'Intuici√≥n' },
        'Sab': { c: 'var(--violeta)', n: 'Corona', i: 'Conexi√≥n' }
    };

    const FOOD_DB = [
        // PROTE√çNAS
        { n: "Filete (A)", t: "A", c: "rojo", cat: "Prote√≠nas", p: 25000 },
        { n: "Mechada (A)", t: "A", c: "rojo", cat: "Prote√≠nas", p: 18000 },
        { n: "Bistec (A)", t: "A", c: "rojo", cat: "Prote√≠nas", p: 22000 },
        { n: "H√≠gado (A)", t: "A", c: "rojo", cat: "Prote√≠nas", p: 9000 },
        { n: "Cordero (A)", t: "A", c: "rojo", cat: "Prote√≠nas", p: 35000 },
        { n: "Lomo (A)", t: "A", c: "rojo", cat: "Prote√≠nas", p: 20000 },
        { n: "Churrasco (A)", t: "A", c: "rojo", cat: "Prote√≠nas", p: 28000 },
        { n: "Costillas de Res (A)", t: "A", c: "rojo", cat: "Prote√≠nas", p: 24000 },
        { n: "Carne Molida (A)", t: "A", c: "rojo", cat: "Prote√≠nas", p: 16000 },
        { n: "Angus (A)", t: "A", c: "rojo", cat: "Prote√≠nas", p: 45000 },
        { n: "Pollo (A)", t: "A", c: "blanco", cat: "Prote√≠nas", p: 14000 },
        { n: "Pavo (A)", t: "A", c: "blanco", cat: "Prote√≠nas", p: 19000 },
        { n: "Huevos (A)", t: "A", c: "amarillo", cat: "Prote√≠nas", p: 700 },
        { n: "Codorniz (A)", t: "A", c: "blanco", cat: "Prote√≠nas", p: 1200 },
        { n: "Chuleta de Cerdo (A)", t: "A", c: "rojo", cat: "Prote√≠nas", p: 15000 },
        { n: "Chorizo (A)", t: "A", c: "rojo", cat: "Prote√≠nas", p: 4000 },
        { n: "Pernil (A)", t: "A", c: "rojo", cat: "Prote√≠nas", p: 26000 },
        { n: "Tocino (A)", t: "A", c: "rojo", cat: "Prote√≠nas", p: 9000 },
        { n: "Jam√≥n Serrano (A)", t: "A", c: "rojo", cat: "Prote√≠nas", p: 12000 },
        { n: "Salm√≥n (A)", t: "A", c: "naranja", cat: "Prote√≠nas", p: 42000 },
        { n: "At√∫n (A)", t: "A", c: "azul", cat: "Prote√≠nas", p: 8000 },
        { n: "Bacalao (A)", t: "A", c: "azul", cat: "Prote√≠nas", p: 38000 },
        { n: "Mero (A)", t: "A", c: "azul", cat: "Prote√≠nas", p: 32000 },
        { n: "Tilapia (A)", t: "A", c: "azul", cat: "Prote√≠nas", p: 15000 },
        { n: "Camarones (A)", t: "A", c: "azul", cat: "Prote√≠nas", p: 35000 },
        { n: "Langosta (A)", t: "A", c: "azul", cat: "Prote√≠nas", p: 95000 },
        { n: "Pulpo (A)", t: "A", c: "azul", cat: "Prote√≠nas", p: 55000 },
        { n: "Calamares (A)", t: "A", c: "azul", cat: "Prote√≠nas", p: 25000 },
        { n: "Cangrejo (A)", t: "A", c: "azul", cat: "Prote√≠nas", p: 48000 },
        { n: "Almejas (A)", t: "A", c: "azul", cat: "Prote√≠nas", p: 22000 },
        // VEGETALES
        { n: "Apio (A)", t: "A", c: "verde", cat: "Vegetales", p: 3500 },
        { n: "Br√≥coli (A)", t: "A", c: "verde", cat: "Vegetales", p: 5000 },
        { n: "Col Rizada (A)", t: "A", c: "verde", cat: "Vegetales", p: 4500 },
        { n: "Espinacas (A)", t: "A", c: "verde", cat: "Vegetales", p: 3500 },
        { n: "Lechuga (A)", t: "A", c: "verde", cat: "Vegetales", p: 4000 },
        { n: "Esp√°rragos (A)", t: "A", c: "verde", cat: "Vegetales", p: 12000 },
        { n: "Habichuelas (A)", t: "A", c: "verde", cat: "Vegetales", p: 3000 },
        { n: "Chayote (A)", t: "A", c: "verde", cat: "Vegetales", p: 2500 },
        { n: "Zucchini (A)", t: "A", c: "verde", cat: "Vegetales", p: 3500 },
        { n: "Aguacate (A)", t: "A", c: "verde", cat: "Vegetales", p: 5000 },
        { n: "Pimiento Verde (A)", t: "A", c: "verde", cat: "Vegetales", p: 2000 },
        { n: "Pimiento Rojo (A)", t: "A", c: "rojo", cat: "Vegetales", p: 2200 },
        { n: "Pimiento Amarillo (A)", t: "A", c: "amarillo", cat: "Vegetales", p: 2500 },
        { n: "R√∫cula (A)", t: "A", c: "verde", cat: "Vegetales", p: 6000 },
        { n: "Zanahorias (A)", t: "A", c: "naranja", cat: "Vegetales", p: 1500 },
        { n: "Berenjena (A)", t: "A", c: "violeta", cat: "Vegetales", p: 3500 },
        // L√ÅCTEOS
        { n: "Queso Manchego (A)", t: "A", c: "amarillo", cat: "L√°cteos/Quesos", p: 15000 },
        { n: "Queso Cheddar (A)", t: "A", c: "amarillo", cat: "L√°cteos/Quesos", p: 12000 },
        { n: "Queso Mozzarella (A)", t: "A", c: "blanco", cat: "L√°cteos/Quesos", p: 10000 },
        { n: "Queso Feta (A)", t: "A", c: "blanco", cat: "L√°cteos/Quesos", p: 18000 },
        { n: "Yogur Griego sin az√∫car (A)", t: "A", c: "blanco", cat: "L√°cteos/Quesos", p: 4500 },
        { n: "Mantequilla (A)", t: "A", c: "amarillo", cat: "L√°cteos/Quesos", p: 8000 },
        // CARBOHIDRATOS E
        { n: "Arroz Blanco (E)", t: "E", c: "blanco", cat: "Carbohidratos E", p: 2200 },
        { n: "Arroz Integral (E)", t: "E", c: "blanco", cat: "Carbohidratos E", p: 3500 },
        { n: "Pan Blanco (E)", t: "E", c: "blanco", cat: "Carbohidratos E", p: 4000 },
        { n: "Pan Integral (E)", t: "E", c: "blanco", cat: "Carbohidratos E", p: 5500 },
        { n: "Pasta (E)", t: "E", c: "blanco", cat: "Carbohidratos E", p: 3800 },
        { n: "Papa / Patata (E)", t: "E", c: "blanco", cat: "Carbohidratos E", p: 2000 },
        { n: "Ma√≠z (E)", t: "E", c: "amarillo", cat: "Carbohidratos E", p: 2500 },
        { n: "Tortilla de Ma√≠z (E)", t: "E", c: "amarillo", cat: "Carbohidratos E", p: 1000 },
        { n: "Harina de Trigo (E)", t: "E", c: "blanco", cat: "Carbohidratos E", p: 3000 },
        { n: "Az√∫car (E)", t: "E", c: "blanco", cat: "Carbohidratos E", p: 4500 },
        { n: "Cereal de Caja (E)", t: "E", c: "amarillo", cat: "Carbohidratos E", p: 15000 },
        { n: "Avena (E)", t: "E", c: "blanco", cat: "Carbohidratos E", p: 6000 },
        { n: "Granola (E)", t: "E", c: "blanco", cat: "Carbohidratos E", p: 12000 },
        { n: "Pl√°tano Maduro (E)", t: "E", c: "amarillo", cat: "Carbohidratos E", p: 1500 },
        { n: "Yuca (E)", t: "E", c: "blanco", cat: "Carbohidratos E", p: 2000 },
        { n: "Camote / Batata (E)", t: "E", c: "naranja", cat: "Carbohidratos E", p: 3000 },
        { n: "Refrescos Dulces (E)", t: "E", c: "rojo", cat: "Carbohidratos E", p: 4500 },
        { n: "Pizza (E)", t: "E", c: "rojo", cat: "Carbohidratos E", p: 25000 }
    ];

    let schedule = JSON.parse(localStorage.getItem('ns_plan_pro')) || {};
    let customPrices = JSON.parse(localStorage.getItem('ns_prices_pro')) || {};
    let selectedKey = 'Dom-A';

    function getPrice(name) {
        return customPrices[name] !== undefined ? parseInt(customPrices[name]) : (FOOD_DB.find(f => f.n === name)?.p || 0);
    }

    function updatePrice(name, e) {
        e.stopPropagation();
        const nPrice = prompt(`Editar precio COP para ${name}:`, getPrice(name));
        if (nPrice !== null && !isNaN(nPrice)) {
            customPrices[name] = parseInt(nPrice);
            localStorage.setItem('ns_prices_pro', JSON.stringify(customPrices));
            renderLibrary(); renderGrid(); analyze();
        }
    }

    function renderLibrary() {
        const search = document.getElementById('search').value.toLowerCase();
        const cats = [...new Set(FOOD_DB.map(f => f.cat))];
        document.getElementById('accordionLibrary').innerHTML = cats.map(cat => {
            const items = FOOD_DB.filter(f => f.cat === cat && f.n.toLowerCase().includes(search));
            if (!items.length) return '';
            return `<button class="accordion-header" onclick="this.nextElementSibling.classList.toggle('active')">${cat} ‚ñæ</button>
                    <div class="accordion-content active">${items.map(f => `
                        <div class="food-item" style="--f-color: var(--${f.c})">
                            <div class="food-name" onclick="addItem('${f.n}')">
                                <div class="dot ${f.t==='A'?'dot-a':'dot-e'}"></div> ${f.n}
                            </div>
                            <div class="price-box">
                                <span class="price-val">${getPrice(f.n).toLocaleString('es-CO')}</span>
                                <span class="btn-edit" onclick="updatePrice('${f.n}', event)">‚úèÔ∏è</span>
                            </div>
                        </div>`).join('')}</div>`;
        }).join('');
    }

    function renderGrid() {
        let total = 0;
        document.getElementById('grid').innerHTML = Object.entries(CHAKRAS).map(([day, info]) => `
            <div class="day-col" style="--d-color: ${info.c}">
                <div class="day-head"><b>${day}</b><span>${info.n}</span></div>
                ${['D', 'A', 'C'].map(m => {
                    const k = `${day}-${m}`;
                    (schedule[k] || []).forEach(n => total += getPrice(n));
                    return `<div class="meal-box ${selectedKey===k?'selected':''}" onclick="selectMeal('${k}')">
                        ${(schedule[k] || []).map((n, i) => {
                            const f = FOOD_DB.find(x => x.n === n);
                            return `<div class="plate-item" style="--f-color: var(--${f?.c || 'gray'})">${n} 
                                <span class="btn-remove" onclick="removeItem('${k}', ${i}, event)">√ó</span></div>`;
                        }).join('')}
                    </div>`;
                }).join('')}
            </div>`).join('');
        document.getElementById('totalBudget').innerText = "COP " + total.toLocaleString('es-CO');
    }

    function selectMeal(k) { selectedKey = k; renderGrid(); analyze(); }
    function addItem(n) { if(!schedule[selectedKey]) schedule[selectedKey] = []; schedule[selectedKey].push(n); save(); }
    function removeItem(k, i, e) { e.stopPropagation(); schedule[k].splice(i, 1); save(); }
    function save() { localStorage.setItem('ns_plan_pro', JSON.stringify(schedule)); renderGrid(); analyze(); }

    function analyze() {
        const dayPrefix = selectedKey.split('-')[0];
        const info = CHAKRAS[dayPrefix];
        const items = schedule[selectedKey] || [];
        let a = 0, e = 0;
        items.forEach(n => { const f = FOOD_DB.find(x => x.n === n); if(f?.t === 'A') a++; else e++; });
        
        const total = a + e;
        const ePerc = total > 0 ? (e / total) * 100 : 0;
        document.getElementById('plateChart').style.background = total > 0 ? `conic-gradient(var(--tipo-e) 0% ${ePerc}%, var(--tipo-a) ${ePerc}% 100%)` : '#334155';
        
        document.getElementById('analysisTitle').innerText = `Plato ${selectedKey}`;
        const badge = document.getElementById('chakraBadge');
        badge.innerText = `Chakra ${info.n}: ${info.i}`;
        badge.style.background = info.c;
        document.getElementById('analysisDesc').innerText = `${a} Alimentos A | ${e} Alimentos E`;
    }

    function printList() {
        const all = Object.values(schedule).flat();
        const summary = all.reduce((acc, n) => { acc[n] = (acc[n] || 0) + 1; return acc; }, {});
        let rows = "", total = 0;
        for(let n in summary) {
            const p = getPrice(n);
            total += (p * summary[n]);
            rows += `<tr><td>${n}</td><td>${summary[n]}</td><td>$${p.toLocaleString()}</td><td>$${(p*summary[n]).toLocaleString()}</td></tr>`;
        }
        document.getElementById('printArea').innerHTML = `<h2>üõí Lista de Compras Chakra 3x1</h2><table><thead><tr><th>Item</th><th>Cant</th><th>Precio Unit</th><th>Subtotal</th></tr></thead><tbody>${rows}</tbody><tfoot><tr><th colspan="3">TOTAL ESTIMADO</th><th>COP ${total.toLocaleString()}</th></tr></tfoot></table>`;
        window.print();
    }

    renderLibrary(); renderGrid(); analyze();
</script>
</body>
</html>